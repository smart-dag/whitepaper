
# SDAG业务模型

业务最终状态是每个事件状态变化的和，如果我们可以确定每个事件的发生的先后顺序，则当前状态可以表达为事件造成影响的累积
```
S = Si + ∑△s
```
其中每一个事件造成的转态变化用△s表示，Si是初始化的状态。

## 临时状态空间和稳定状态空间
对于已经达到稳定的单元来说，我们可以确定事件的全局顺序，因此计算业务的最终状态比较容易。我们把此时修改的状态空间称为稳定状态空间，SSS（Stable State Space）。

对于未稳定的单元来说，由于其全局序没有确定，所以不能直接修改状态空间。但我们依然需要某种算法来阻止非法的状态改变，比如余额不足的账号不能成功发送交易。为了拦截这类非法的事件，我们引入了临时状态空间，TSS（Temp State Space）。

在单元未稳定时，我们修改的是TSS，其验证是并行的，无序的。这样虽然极大地提高效率，但是可能会有少数非法单元，甚至双花单元通过校验。虽然之后这些单元会被主链算法设为稳定状态，但它在之后的入SSS验证阶段，验证是严格按照顺序进行检查的，此时非法单元一定会被检测到。例如，两个双花单元A、B，在TSS验证阶段，A被认为是合法的，B被认为是非法的，由于在这一阶段是并行处理的，因此到其最终稳定顺序不确定，这就影响了A、B的最终状态，他们在稳定状态空间的状态可能和在临时状态空间的状态完全不同。  

值得注意的是，SDAG是不可回退的，确定性的，所以保留单元的全部历史状态空间是不必要的，我们仅仅需要保持当前的历史状态。基于此，SDAG的状态空间仅仅保存当前的状态，对状态空间的历史改变不会保留，这就极大地节省了状态空间的存储大小。

## 状态空间一致性
临时状态空间和稳定状态空间所做的工作基本是相同的。在稳定状态空间里，只包含已稳定单元的状态，且状态不可逆。临时状态空间既包含那些已经上链但是还没稳定的单元状态，也包括已经稳定的单元的状态。对于一个特定的地址，他的临时状态空间内的状态已经更改，但是单元校验失败，临时状态空间会被恢复到之前的状态。例如，当一个地址要花钱时，SDAG首先会更改临时状态空间的状态，然后才会更改稳定状态空间的的状态。如果某地址所有相关单元都已稳定，则该地址的临时状态空间和稳定状态空间是最终一致的。若该地址有未稳定单元，则稳定状态空间相对于临时状态空间，缺少未稳定部分。同时稳定状态空间的最终结果也会影响临时状态空间的，临时状态空间错误的处理可能会被回退，以保持跟稳定状态空间的一致。


## 结论

临时状态空间的引入，可以使得非法的事件得以提前处理和拦截。极大的提升了SDAG的安全性和效率。临时状态空间和稳定状态空间以接口形式接受事件，与主链共识算法完全解耦。用户完全可以定制自己的业务逻辑，结合SDAG共识算法实现自己的业务需求。UTXO作为一个基本的交易功能，正是业务在这种模型下的一种实现。